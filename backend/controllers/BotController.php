<?php
namespace backend\controllers;

use Yii;
use yii\web\Controller;

use backend\helpers\BotHelper;
use backend\helpers\ValidationHelper;

use backend\bots\Bot;
use backend\models\BotUser;
 
class BotController extends Controller
{
    private $bot;

    private $chatId;
    private $currentMessage;
    private $postData;
    private $user;

    public function behaviors()
    {
        return array_merge([
            'cors' => [
                'class' => \yii\filters\Cors::className(),
                #special rules for particular action
                'actions' => [
                    'test-request' => [
                        #web-servers which you alllow cross-domain access
                        'Origin' => ['*'],
                        'Access-Control-Request-Method' => ['POST'],
                        'Access-Control-Request-Headers' => ['*'],
                        'Access-Control-Allow-Credentials' => null,
                        'Access-Control-Max-Age' => 86400,
                        'Access-Control-Expose-Headers' => [],
                    ]
                ],
                #common rules
                'cors' => [
                    'Origin' => [],
                    'Access-Control-Request-Method' => [],
                    'Access-Control-Request-Headers' => [],
                    'Access-Control-Allow-Credentials' => null,
                    'Access-Control-Max-Age' => 0,
                    'Access-Control-Expose-Headers' => [],
                ]
            ],
        ], parent::behaviors());

    }

    public function beforeAction($action)//ĞĞ±ÑĞ·Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ Ğ½ÑƒĞ¶Ğ½Ğ¾ Ğ¾Ñ‚ĞºĞ»ÑÑ‡Ğ¸Ñ‚ÑŒ Csr Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ñ, Ñ‚Ğ°Ğº Ğ½Ğµ Ğ±ÑƒĞ´ĞµÑ‚ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ñ‚ÑŒ
    {
        $this->enableCsrfValidation = false;
        return parent::beforeAction($action);
    }

    public function actionWebhook()
    {        
        $this->chatId = 712226559;

        /* Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ±Ğ¾Ñ‚Ğ° */
        $this->bot = new Bot('5780876936:AAGtj-8WeL-WlsE9QmzuH6URFTPxPd3EMI8', $this->chatId);

         $this->sendMessageWithInlineKeyboardArray(
            "Ğ§Ñ‚Ğ¾ Ğ²Ñ‹ Ñ…Ğ¾Ñ‚Ğ¸Ñ‚Ğµ ÑĞ´ĞµĞ»Ğ°Ñ‚ÑŒ?",
            [
                ['text' => 'ğŸ“§ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ¿Ğ¾ÑÑ‚', 'callback_data' => 'send_post'],
                ['text' => "ğŸ’»Ğ¡Ğ¼Ğ¾Ñ‚Ñ€ĞµÑ‚ÑŒ Ğ¿Ğ¾ÑÑ‚Ñ‹ (5 ĞºÑ€Ğ°Ğ¹Ğ½Ğ¸Ñ…)", 'callback_data' => 'watch_posts'],
            ]
        );

        $this->postData = BotHelper::getPostData();

        $this->sendMessageWithInlineKeyboard(
            "<b>ĞŸÑ€Ğ¸Ğ²ĞµÑ‚ÑÑ‚Ğ²ÑƒÑ Ñ‚ĞµÑ€Ğ¿Ğ¸Ğ»ğŸ˜Œ</b>\n",
            $this->postData['callback_query']['data'],
            // 'af',
            'da'
        );

        /* Ğ¢ĞµĞºÑƒÑ‰Ğ¸Ğ¹ Ğ¾Ñ‚Ğ²ĞµÑ‚ Ğ¾Ñ‚ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ */
        $this->postData = BotHelper::getPostData();
        $this->chatId = $this->postData['message']['chat']['id'];
        $this->currentMessage = trim($this->postData['message']['text']);
        
        /* Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ±Ğ¾Ñ‚Ğ° */
        $this->bot = new Bot('5780876936:AAGtj-8WeL-WlsE9QmzuH6URFTPxPd3EMI8', $this->chatId);
        
        /* Ğ¢ĞµĞºÑƒÑ‰Ğ¸Ğ¹ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ */
        $user = BotUser::getUser($this->chatId);
        $user->setLastSendAt();
        $user->saveLastMessage($this->currentMessage);

        // Ğ•ÑĞ»Ğ¸ Ñ‚ĞµĞºÑÑ‚Ğ¾Ğ²Ğ¾Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ
        if (BotHelper::isTextMessage($this->postData)) {

            switch($user->step_message) {
                case 0:
                    $this->sendMessage(
                        "<b>ĞŸÑ€Ğ¸Ğ²ĞµÑ‚ÑÑ‚Ğ²ÑƒÑ Ñ‚ĞµÑ€Ğ¿Ğ¸Ğ»ğŸ˜Œ</b>\n"
                    );

                    $user->setStepMessage(1);
                break;
    
                case 1:
                    $this->sendMessage(
                        "<b>ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ÑŒ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ´Ğ»Ñ Ğ´Ñ€ÑƒĞ³Ğ¸Ñ… Ñ‚ĞµÑ€Ğ¿Ğ¸Ğ»</b>\n"
                    );

                    $user->setStepMessage(2);
                break;
                
                case 2:
                break;
    
                default:
                    $this->sendMessage(
                        "<b>Ğ¡Ğ¿Ğ°ÑĞ¸Ğ±Ğ¾, Ñ‡Ñ‚Ğ¾ Ğ²Ñ‹ Ñ Ğ½Ğ°Ğ¼Ğ¸ğŸ˜Œ</b>\n"
                    );
                break;
            }

            $user->save();           
        }

        return true;
    }

    private function sendMessage($message) 
    {
        $this->bot->sendMessage($message);
    }

    private function sendMessageWithKeyboard($message, $keyboardData  = [[["text" => "Ğ”Ğ°Ğ»ÑŒÑˆĞµ"]]]) 
    {
        $keyboard = $this->bot->getOneTimeKeyboard($keyboardData);

        $this->bot->sendMessageWithKeyboard($message, $keyboard);
    }

    private function sendMessageWithInlineKeyboard($message, $button_text, $callback) 
    {
        $keyboardData = [
            ['text' => $button_text, 'callback_data' => $callback],
        ];

        $keyboard = $this->bot->getInlineKeyBoard([$keyboardData]);
        $this->bot->sendMessageWithInlineKeyboard($message, $keyboard);
    }

    private function sendMessageWithInlineKeyboardArray($message, $keyboardData) 
    {
        $keyboard = $this->bot->getInlineKeyBoard([$keyboardData]); 
        $this->bot->sendMessageWithInlineKeyboard($message, $keyboard);
    }

    private function sendMessageWithPhotoAndKeyboard($message, $button_text = null, $callback = null, $button_url = null, $photoUrl = null) 
    {
        if (!empty($button_url)) {
            $keyboardData = [
                ['text' => $button_text, 'url' => $button_url,'callback_data' => $callback],
            ];
        } else {
            $keyboardData = [
                ['text' => $button_text,'callback_data' => $callback],
            ];
        }

        $keyboard = $this->bot->getInlineKeyBoard([$keyboardData]);

        if (!empty($photoUrl) && !empty($keyboardData)) {

            $this->bot->sendMessageWithPhotoAndKeyboard($message, $keyboard, $photoUrl);

        } else if (empty($photoUrl) && !empty($keyboardData)) {

            $this->bot->sendMessageWithInlineKeyboard($message, $keyboard);

        } else if (!empty($photoUrl) && empty($keyboardData)) {

            $this->bot->sendMessageWithPhoto($message, $photoUrl);

        } else {

            $this->bot->sendMessage($message);

        }
    }

    private function sendMessageWithPhoto($message, $photoUrl = null) 
    {
        if (!empty($photoUrl)) {
            $this->bot->sendMessageWithPhoto($message, $photoUrl);
        } else {
            $this->bot->sendMessage($message);
        }
    }
}
